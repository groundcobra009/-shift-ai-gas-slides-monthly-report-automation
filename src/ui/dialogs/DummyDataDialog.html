<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Noto Sans JP', -apple-system, BlinkMacSystemFont, sans-serif;
      padding: 24px;
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      min-height: 100vh;
    }
    .container {
      max-width: 700px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      overflow: hidden;
    }
    .header {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      padding: 32px 24px;
      text-align: center;
    }
    .header h1 {
      font-size: 28px;
      margin-bottom: 8px;
    }
    .content {
      padding: 32px 24px;
    }
    .info-box {
      background: #dbeafe;
      border-left: 4px solid #3b82f6;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 24px;
      font-size: 14px;
      color: #1e40af;
      line-height: 1.6;
    }
    .info-box h3 {
      font-size: 16px;
      margin-bottom: 8px;
    }
    .info-box code {
      background: #f1f5f9;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 12px;
    }
    .warning-box {
      background: #fef3c7;
      border-left: 4px solid #f59e0b;
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 13px;
      color: #92400e;
    }
    .upload-area {
      border: 3px dashed #10b981;
      border-radius: 12px;
      padding: 32px;
      text-align: center;
      margin-bottom: 24px;
      background: #f0fdf4;
      transition: all 0.3s;
    }
    .upload-area:hover {
      background: #dcfce7;
      border-color: #059669;
    }
    .upload-area input[type="file"] {
      display: none;
    }
    .upload-btn {
      display: inline-block;
      padding: 12px 24px;
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
    }
    .upload-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
    }
    textarea {
      width: 100%;
      min-height: 200px;
      padding: 12px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 12px;
      font-family: 'Monaco', 'Courier New', monospace;
      resize: vertical;
      margin-bottom: 16px;
    }
    textarea:focus {
      outline: none;
      border-color: #10b981;
      box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
    }
    .preview-box {
      display: none;
      background: #f8fafc;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 20px;
    }
    .preview-box.show { display: block; }
    .preview-box h3 {
      font-size: 14px;
      color: #10b981;
      margin-bottom: 12px;
    }
    .preview-stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      font-size: 13px;
    }
    .stat-item {
      background: white;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #e5e7eb;
    }
    .stat-label {
      font-size: 11px;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .stat-value {
      font-size: 18px;
      font-weight: 700;
      color: #10b981;
      margin-top: 4px;
    }
    .btn {
      width: 100%;
      padding: 16px 24px;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      margin-bottom: 12px;
    }
    .btn-primary {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
    }
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(16, 185, 129, 0.5);
    }
    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    .btn-secondary {
      background: #e5e7eb;
      color: #4b5563;
    }
    .btn-secondary:hover {
      background: #d1d5db;
    }
    .result {
      display: none;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    .result.show { display: block; }
    .result.success {
      background: #d1fae5;
      border: 2px solid #6ee7b7;
      color: #065f46;
    }
    .result.error {
      background: #fee2e2;
      border: 2px solid #fca5a5;
      color: #991b1b;
    }
    .loading {
      display: none;
      text-align: center;
      padding: 48px 24px;
    }
    .loading.show { display: block; }
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #10b981;
      border-radius: 50%;
      width: 48px;
      height: 48px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ“Š ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ä½œæˆ</h1>
      <p>CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦é›†è¨ˆã‚·ãƒ¼ãƒˆã‚’ä½œæˆ</p>
    </div>

    <div class="content">
      <div id="result" class="result"></div>

      <div class="info-box">
        <h3>ğŸ“‹ ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆæ–¹æ³•</h3>
        <p style="margin-bottom: 12px;">
          ç¾å®Ÿçš„ãªãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆã™ã‚‹ã«ã¯ã€Pythonã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„:
        </p>
        <p style="margin-bottom: 8px;">
          <code>python generate_realistic_data.py</code>
        </p>
        <p>
          ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯2025å¹´1æœˆã€œ12æœˆã®ç´„10,000ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã—ã€<br>
          å­£ç¯€æ€§ã€æ›œæ—¥åŠ¹æœã€ãƒˆãƒ¬ãƒ³ãƒ‰ã€æ‹…å½“è€…ã®ç‰¹æ€§ã‚’è€ƒæ…®ã—ãŸç¾å®Ÿçš„ãªãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆã—ã¾ã™ã€‚
        </p>
      </div>

      <div class="warning-box">
        âš ï¸ æ—¢å­˜ã®ã€ŒRawSalesDataã€ãŠã‚ˆã³é›†è¨ˆã‚·ãƒ¼ãƒˆã¯å‰Šé™¤ã•ã‚Œã¾ã™
      </div>

      <div id="uploadSection">
        <div class="upload-area">
          <div style="font-size: 48px; margin-bottom: 12px;">ğŸ“</div>
          <p style="color: #10b981; font-weight: 600; margin-bottom: 8px;">
            CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—
          </p>
          <p style="font-size: 13px; color: #64748b; margin-bottom: 16px;">
            ã¾ãŸã¯
          </p>
          <label for="fileInput" class="upload-btn">
            ğŸ“‚ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ
          </label>
          <input type="file" id="fileInput" accept=".csv" onchange="handleFileSelect(event)" />
        </div>

        <p style="text-align: center; margin: 20px 0; color: #94a3b8; font-weight: 600;">
          ã¾ãŸã¯
        </p>

        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #4b5563;">
          CSVãƒ‡ãƒ¼ã‚¿ã‚’ç›´æ¥è²¼ã‚Šä»˜ã‘:
        </label>
        <textarea id="csvText" placeholder="Date,Region,Person,Product,Category,Quantity,UnitPrice,TotalSales,DayOfWeek,Month,Quarter
2025-01-01,é–¢æ±,ç”°ä¸­å¤ªéƒ,è£½å“A,ã‚µãƒ–ã‚¹ã‚¯,3,45000,135000,Wednesday,1,1
..."></textarea>

        <div id="previewBox" class="preview-box">
          <h3>ğŸ“Š ãƒ‡ãƒ¼ã‚¿ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h3>
          <div class="preview-stats">
            <div class="stat-item">
              <div class="stat-label">ãƒ¬ã‚³ãƒ¼ãƒ‰æ•°</div>
              <div class="stat-value" id="recordCount">-</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">ç·å£²ä¸Š</div>
              <div class="stat-value" id="totalSales">-</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">æœŸé–“é–‹å§‹</div>
              <div class="stat-value" id="dateFrom" style="font-size: 14px;">-</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">æœŸé–“çµ‚äº†</div>
              <div class="stat-value" id="dateTo" style="font-size: 14px;">-</div>
            </div>
          </div>
        </div>

        <button class="btn btn-primary" id="importBtn" onclick="importData()" disabled>
          ğŸš€ ã‚¤ãƒ³ãƒãƒ¼ãƒˆ & é›†è¨ˆå®Ÿè¡Œ
        </button>

        <div style="margin: 20px 0; padding: 16px; background: #f0f9ff; border-left: 4px solid #0284c7; border-radius: 8px;">
          <p style="font-size: 13px; color: #0c4a6e; margin-bottom: 8px; font-weight: 600;">
            ğŸ“Š RawSalesDataã‚’æ‰‹å‹•æ›´æ–°ã—ãŸå ´åˆ
          </p>
          <p style="font-size: 12px; color: #075985; margin-bottom: 12px;">
            ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆä¸Šã§RawSalesDataã‚’ç›´æ¥ç·¨é›†ã—ãŸå ´åˆã€ã“ã®ãƒœã‚¿ãƒ³ã§é›†è¨ˆã‚·ãƒ¼ãƒˆã‚’æ›´æ–°ã§ãã¾ã™ã€‚
          </p>
          <button class="btn btn-secondary" onclick="refreshSheets()" style="background: #0284c7; color: white;">
            ğŸ”„ é›†è¨ˆã‚·ãƒ¼ãƒˆã‚’æ›´æ–°
          </button>
        </div>

        <button class="btn btn-secondary" onclick="google.script.host.close()">
          âœ• é–‰ã˜ã‚‹
        </button>
      </div>

      <div id="loading" class="loading">
        <div class="spinner"></div>
        <div style="color: #10b981; font-weight: 600; font-size: 16px;">
          ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸­...
        </div>
        <p style="color: #9ca3af; font-size: 13px; margin-top: 12px;">
          é›†è¨ˆã‚·ãƒ¼ãƒˆã®ä½œæˆã¨ã‚°ãƒ©ãƒ•ã®ç”Ÿæˆã‚’è¡Œã£ã¦ã„ã¾ã™
        </p>
      </div>
    </div>
  </div>

  <script>
    let currentCsvData = null;

    // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠæ™‚ã®å‡¦ç†
    function handleFileSelect(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        const csvText = e.target.result;
        document.getElementById('csvText').value = csvText;
        previewData(csvText);
      };
      reader.readAsText(file, 'UTF-8');
    }

    // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®å¤‰æ›´ã‚’ç›£è¦–
    document.getElementById('csvText').addEventListener('input', function(e) {
      const csvText = e.target.value.trim();
      if (csvText) {
        previewData(csvText);
      } else {
        document.getElementById('previewBox').classList.remove('show');
        document.getElementById('importBtn').disabled = true;
      }
    });

    // ãƒ‡ãƒ¼ã‚¿ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
    function previewData(csvText) {
      try {
        const lines = csvText.trim().split('\n');
        if (lines.length < 2) {
          throw new Error('ãƒ‡ãƒ¼ã‚¿ãŒä¸è¶³ã—ã¦ã„ã¾ã™');
        }

        const header = lines[0];
        const dataLines = lines.slice(1);

        // ç°¡æ˜“çš„ãªçµ±è¨ˆè¨ˆç®—
        let totalSales = 0;
        let minDate = null;
        let maxDate = null;

        dataLines.forEach(line => {
          const cols = line.split(',');
          if (cols.length >= 8) {
            const date = cols[0];
            const sales = parseInt(cols[7]) || 0;
            totalSales += sales;

            if (!minDate || date < minDate) minDate = date;
            if (!maxDate || date > maxDate) maxDate = date;
          }
        });

        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
        document.getElementById('recordCount').textContent = dataLines.length.toLocaleString();
        document.getElementById('totalSales').textContent = 'Â¥' + totalSales.toLocaleString();
        document.getElementById('dateFrom').textContent = minDate || '-';
        document.getElementById('dateTo').textContent = maxDate || '-';

        document.getElementById('previewBox').classList.add('show');
        document.getElementById('importBtn').disabled = false;

        currentCsvData = csvText;
      } catch (error) {
        showResult(false, 'CSVã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ä½œæˆã«å¤±æ•—: ' + error.message);
        document.getElementById('previewBox').classList.remove('show');
        document.getElementById('importBtn').disabled = true;
      }
    }

    // ãƒ‡ãƒ¼ã‚¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Ÿè¡Œ
    function importData() {
      if (!currentCsvData) {
        showResult(false, 'CSVãƒ‡ãƒ¼ã‚¿ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“');
        return;
      }

      document.getElementById('uploadSection').style.display = 'none';
      document.getElementById('loading').classList.add('show');
      document.getElementById('result').classList.remove('show');

      google.script.run
        .withSuccessHandler(function(result) {
          document.getElementById('loading').classList.remove('show');
          document.getElementById('uploadSection').style.display = 'block';

          if (result.success) {
            showResult(true, `âœ… ${result.message}<br><br>ä»¥ä¸‹ã®ã‚·ãƒ¼ãƒˆãŒä½œæˆã•ã‚Œã¾ã—ãŸ:<br>ãƒ»RawSalesData<br>ãƒ»Region<br>ãƒ»Person<br>ãƒ»Product<br>ãƒ»Category<br>ãƒ»Monthly`);

            // å…¥åŠ›ã‚’ã‚¯ãƒªã‚¢
            document.getElementById('csvText').value = '';
            document.getElementById('previewBox').classList.remove('show');
            document.getElementById('importBtn').disabled = true;
            currentCsvData = null;
          } else {
            showResult(false, result.message);
          }
        })
        .withFailureHandler(function(error) {
          document.getElementById('loading').classList.remove('show');
          document.getElementById('uploadSection').style.display = 'block';
          showResult(false, 'ã‚¨ãƒ©ãƒ¼: ' + error.message);
        })
        .importAndAggregateSalesData(currentCsvData);
    }

    // é›†è¨ˆã‚·ãƒ¼ãƒˆæ›´æ–°
    function refreshSheets() {
      document.getElementById('uploadSection').style.display = 'none';
      document.getElementById('loading').classList.add('show');
      document.getElementById('loading').querySelector('div:nth-child(2)').textContent = 'é›†è¨ˆã‚·ãƒ¼ãƒˆã‚’æ›´æ–°ä¸­...';
      document.getElementById('result').classList.remove('show');

      google.script.run
        .withSuccessHandler(function(result) {
          document.getElementById('loading').classList.remove('show');
          document.getElementById('uploadSection').style.display = 'block';

          if (result.success) {
            showResult(true, `âœ… ${result.message}<br><br>RawSalesDataã®å¤‰æ›´ãŒé›†è¨ˆã‚·ãƒ¼ãƒˆã«åæ˜ ã•ã‚Œã¾ã—ãŸã€‚`);
          } else {
            showResult(false, result.message);
          }
        })
        .withFailureHandler(function(error) {
          document.getElementById('loading').classList.remove('show');
          document.getElementById('uploadSection').style.display = 'block';
          showResult(false, 'ã‚¨ãƒ©ãƒ¼: ' + error.message);
        })
        .refreshAggregationSheets();
    }

    // çµæœè¡¨ç¤º
    function showResult(success, message) {
      const resultDiv = document.getElementById('result');
      resultDiv.innerHTML = message;
      resultDiv.className = 'result show ' + (success ? 'success' : 'error');
    }
  </script>
</body>
</html>
