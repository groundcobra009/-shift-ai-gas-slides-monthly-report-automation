<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Noto Sans JP', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      padding: 24px;
      background: linear-gradient(135deg, #0f9d58 0%, #0b8043 100%);
      min-height: 100vh;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      overflow: hidden;
    }
    .header {
      background: linear-gradient(135deg, #0f9d58 0%, #0b8043 100%);
      color: white;
      padding: 32px 24px;
      text-align: center;
    }
    .header h1 {
      font-size: 28px;
      margin-bottom: 8px;
      font-weight: 700;
    }
    .header p {
      opacity: 0.9;
      font-size: 14px;
    }
    .content {
      padding: 32px 24px;
    }
    .section {
      margin-bottom: 28px;
    }
    .section-title {
      font-size: 14px;
      font-weight: 700;
      color: #0f9d58;
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .period-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 12px;
      margin-bottom: 16px;
    }
    .period-btn {
      padding: 16px;
      border: 2px solid #c8e6c9;
      border-radius: 12px;
      background: white;
      cursor: pointer;
      transition: all 0.3s;
      text-align: center;
      font-size: 14px;
      font-weight: 600;
      color: #4c4f69;
    }
    .period-btn:hover {
      border-color: #0f9d58;
      background: #e8f5e9;
    }
    .period-btn.active {
      border-color: #0f9d58;
      background: linear-gradient(135deg, #0f9d58 0%, #0b8043 100%);
      color: white;
    }
    .period-btn .icon {
      font-size: 24px;
      margin-bottom: 8px;
    }
    .date-input {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid #c8e6c9;
      border-radius: 12px;
      font-size: 15px;
      transition: all 0.3s;
    }
    .date-input:focus {
      outline: none;
      border-color: #0f9d58;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    .checkbox-group {
      background: #f8f9fc;
      border-radius: 12px;
      padding: 16px;
    }
    .checkbox-item {
      display: flex;
      align-items: center;
      padding: 8px 0;
    }
    .checkbox-item input[type="checkbox"] {
      width: 20px;
      height: 20px;
      margin-right: 12px;
      cursor: pointer;
    }
    .checkbox-item label {
      cursor: pointer;
      font-size: 14px;
      color: #4c4f69;
    }
    .action-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 32px;
    }
    .btn {
      padding: 16px 24px;
      border: none;
      border-radius: 12px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .btn-primary {
      background: linear-gradient(135deg, #0f9d58 0%, #0b8043 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(15, 157, 88, 0.4);
    }
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(102, 126, 234, 0.5);
    }
    .btn-secondary {
      background: white;
      color: #0f9d58;
      border: 2px solid #0f9d58;
    }
    .btn-secondary:hover {
      background: #e8f5e9;
    }
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .result {
      display: none;
      padding: 16px;
      border-radius: 12px;
      margin-bottom: 20px;
      animation: slideDown 0.3s;
    }
    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .result.show { display: block; }
    .result.success {
      background: #d1fae5;
      border: 2px solid #6ee7b7;
      color: #065f46;
    }
    .result.error {
      background: #fee2e2;
      border: 2px solid #fca5a5;
      color: #991b1b;
    }
    .result a {
      color: #0284c7;
      font-weight: 600;
      text-decoration: none;
    }
    .result a:hover {
      text-decoration: underline;
    }
    .loading {
      display: none;
      text-align: center;
      padding: 48px 24px;
    }
    .loading.show { display: block; }
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #0f9d58;
      border-radius: 50%;
      width: 48px;
      height: 48px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .loading-text {
      color: #0f9d58;
      font-weight: 600;
      font-size: 16px;
    }
    .info-box {
      background: #fef3c7;
      border-left: 4px solid #f59e0b;
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 13px;
      color: #92400e;
    }
    .current-slide-info {
      background: #e0f2fe;
      border-left: 4px solid #0284c7;
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 13px;
      color: #0c4a6e;
    }
    .ai-section {
      background: #f8f9fc;
      border-radius: 12px;
      padding: 16px;
    }
    .ai-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 16px;
    }
    .btn-ai {
      padding: 12px 16px;
      border: 2px solid #0f9d58;
      border-radius: 8px;
      background: white;
      color: #0f9d58;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .btn-ai:hover {
      background: #e8f5e9;
      transform: translateY(-1px);
    }
    .btn-ai:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .form-group {
      margin-bottom: 16px;
    }
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-size: 13px;
      font-weight: 600;
      color: #4c4f69;
    }
    .ai-textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #c8e6c9;
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
      resize: vertical;
      transition: all 0.3s;
    }
    .ai-textarea:focus {
      outline: none;
      border-color: #0f9d58;
      box-shadow: 0 0 0 3px rgba(15, 157, 88, 0.1);
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ“Š ã‚¹ãƒ©ã‚¤ãƒ‰ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ</h1>
      <p>æœŸé–“ã‚’é¸æŠã—ã¦ãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆãƒ»æ›´æ–°ã§ãã¾ã™</p>
    </div>

    <div class="content">
      <div id="result" class="result"></div>
      <div id="currentSlideInfo" class="current-slide-info" style="display:none;"></div>

      <div id="form">
        <div class="section">
          <div class="section-title">ğŸ“… æœŸé–“ã‚¿ã‚¤ãƒ—</div>
          <div class="period-buttons">
            <button class="period-btn active" data-period="monthly" onclick="selectPeriod('monthly')">
              <div class="icon">ğŸ“†</div>
              <div>æœˆæ¬¡</div>
            </button>
            <button class="period-btn" data-period="weekly" onclick="selectPeriod('weekly')">
              <div class="icon">ğŸ“…</div>
              <div>é€±æ¬¡</div>
            </button>
            <button class="period-btn" data-period="yearly" onclick="selectPeriod('yearly')">
              <div class="icon">ğŸ“Š</div>
              <div>å¹´æ¬¡</div>
            </button>
          </div>
        </div>

        <div class="section">
          <div class="section-title">ğŸ“ å¯¾è±¡æ—¥</div>
          <input type="date" id="targetDate" class="date-input" />
        </div>

        <div class="section">
          <div class="section-title">ğŸ¤– AIç”Ÿæˆ</div>
          <div class="ai-section">
            <div class="ai-buttons">
              <button class="btn-ai" onclick="generateSalesComment()">
                <span>ğŸ’¬</span>
                <span>å£²ä¸Šã‚³ãƒ¡ãƒ³ãƒˆç”Ÿæˆ</span>
              </button>
              <button class="btn-ai" onclick="generateCustomComment()">
                <span>âœ¨</span>
                <span>ã‚«ã‚¹ã‚¿ãƒ ç”Ÿæˆ</span>
              </button>
            </div>
            <div class="form-group">
              <label for="aiComment">AIã‚³ãƒ¡ãƒ³ãƒˆï¼ˆã‚¹ãƒ©ã‚¤ãƒ‰1æšç›®ç”¨ï¼‰</label>
              <textarea id="aiComment" class="ai-textarea" rows="4" placeholder="å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æã—ã¦ã€ä»Šæœˆã®å‚¾å‘ã¨é‡è¦ãªãƒã‚¤ãƒ³ãƒˆã‚’ç°¡æ½”ã«ã¾ã¨ã‚ã¦ãã ã•ã„ã€‚æ•°å€¤ã‚’å«ã‚ã¦ã€200æ–‡å­—ç¨‹åº¦ã§å…·ä½“çš„ã«è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚"></textarea>
            </div>
            <div class="form-group">
              <label for="aiInsight">AIã‚¤ãƒ³ã‚µã‚¤ãƒˆï¼ˆã‚¹ãƒ©ã‚¤ãƒ‰4æšç›®ç”¨ï¼‰</label>
              <textarea id="aiInsight" class="ai-textarea" rows="6" placeholder="ãƒ“ã‚¸ãƒã‚¹ã‚¤ãƒ³ã‚µã‚¤ãƒˆã¨å…·ä½“çš„ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³ã‚’è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚"></textarea>
            </div>
          </div>
        </div>

        <div class="section">
          <div class="section-title">âš™ï¸ ã‚ªãƒ—ã‚·ãƒ§ãƒ³</div>
          <div class="checkbox-group">
            <div class="checkbox-item">
              <input type="checkbox" id="forceNew" />
              <label for="forceNew">å¼·åˆ¶çš„ã«æ–°è¦ä½œæˆã™ã‚‹ï¼ˆæ—¢å­˜ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’ä¸Šæ›¸ãã—ãªã„ï¼‰</label>
            </div>
          </div>
        </div>

        <div class="action-buttons">
          <button class="btn btn-primary" onclick="generateSlide()">
            <span>ğŸš€</span>
            <span>ç”Ÿæˆãƒ»æ›´æ–°</span>
          </button>
          <button class="btn btn-secondary" onclick="google.script.host.close()">
            <span>âœ•</span>
            <span>é–‰ã˜ã‚‹</span>
          </button>
        </div>
      </div>

      <div id="loading" class="loading">
        <div class="spinner"></div>
        <div class="loading-text">ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’ç”Ÿæˆã—ã¦ã„ã¾ã™...</div>
        <p style="color: #9ca3af; font-size: 13px; margin-top: 12px;">å°‘ã€…ãŠå¾…ã¡ãã ã•ã„</p>
      </div>
    </div>
  </div>

  <script>
    let selectedPeriod = 'monthly';

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚
    window.onload = function() {
      // ä»Šæ—¥ã®æ—¥ä»˜ã‚’ã‚»ãƒƒãƒˆ
      const today = new Date();
      document.getElementById('targetDate').value = formatDate(today);

      // ç¾åœ¨ã®ã‚¹ãƒ©ã‚¤ãƒ‰æƒ…å ±ã‚’å–å¾—
      loadCurrentSlideInfo();
      
      // å¯¾è±¡æ—¥å¤‰æ›´æ™‚ã«è‡ªå‹•çš„ã«ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
      document.getElementById('targetDate').addEventListener('change', previewData);
      
      // åˆæœŸãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
      previewData();
    };
    
    // ãƒ‡ãƒ¼ã‚¿ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆæœŸé–“é¸æŠæ™‚ã«è‡ªå‹•å®Ÿè¡Œï¼‰
    function previewData() {
      const targetDate = document.getElementById('targetDate').value;
      if (!targetDate) return;
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success && result.data) {
            // AIã‚³ãƒ¡ãƒ³ãƒˆã¨AIã‚¤ãƒ³ã‚µã‚¤ãƒˆãŒè‡ªå‹•ç”Ÿæˆã•ã‚Œã¦ã„ã‚‹å ´åˆã¯è¡¨ç¤º
            if (result.data.aiComment) {
              document.getElementById('aiComment').value = result.data.aiComment;
            }
            if (result.data.aiInsight) {
              document.getElementById('aiInsight').value = result.data.aiInsight;
            }
          }
        })
        .withFailureHandler(function(error) {
          console.log('ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒ©ãƒ¼: ' + error.message);
        })
        .previewReportData(selectedPeriod, targetDate);
    }
    
    // å£²ä¸Šã‚³ãƒ¡ãƒ³ãƒˆç”Ÿæˆ
    function generateSalesComment() {
      const targetDate = document.getElementById('targetDate').value;
      if (!targetDate) {
        showResult(false, 'å¯¾è±¡æ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }
      
      const commentTextarea = document.getElementById('aiComment');
      commentTextarea.disabled = true;
      commentTextarea.value = 'AIã‚³ãƒ¡ãƒ³ãƒˆã‚’ç”Ÿæˆä¸­...';
      
      google.script.run
        .withSuccessHandler(function(result) {
          commentTextarea.disabled = false;
          if (result.success && result.text) {
            commentTextarea.value = result.text;
            showResult(true, 'AIã‚³ãƒ¡ãƒ³ãƒˆã‚’ç”Ÿæˆã—ã¾ã—ãŸ');
          } else {
            commentTextarea.value = '';
            showResult(false, result.message || 'AIã‚³ãƒ¡ãƒ³ãƒˆã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
          }
        })
        .withFailureHandler(function(error) {
          commentTextarea.disabled = false;
          commentTextarea.value = '';
          showResult(false, 'ã‚¨ãƒ©ãƒ¼: ' + error.message);
        })
        .generateAIComment({
          periodType: selectedPeriod,
          targetDate: targetDate
        });
    }
    
    // ã‚«ã‚¹ã‚¿ãƒ ç”Ÿæˆï¼ˆãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®å†…å®¹ã‚’ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¨ã—ã¦ä½¿ç”¨ï¼‰
    function generateCustomComment() {
      const targetDate = document.getElementById('targetDate').value;
      const customPrompt = document.getElementById('aiComment').value;
      
      if (!targetDate) {
        showResult(false, 'å¯¾è±¡æ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }
      
      if (!customPrompt || customPrompt.trim() === '') {
        showResult(false, 'ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      
      const commentTextarea = document.getElementById('aiComment');
      commentTextarea.disabled = true;
      const originalValue = commentTextarea.value;
      commentTextarea.value = 'ã‚«ã‚¹ã‚¿ãƒ AIã‚³ãƒ¡ãƒ³ãƒˆã‚’ç”Ÿæˆä¸­...';
      
      google.script.run
        .withSuccessHandler(function(result) {
          commentTextarea.disabled = false;
          if (result.success && result.text) {
            commentTextarea.value = result.text;
            showResult(true, 'ã‚«ã‚¹ã‚¿ãƒ AIã‚³ãƒ¡ãƒ³ãƒˆã‚’ç”Ÿæˆã—ã¾ã—ãŸ');
          } else {
            commentTextarea.value = originalValue;
            showResult(false, result.message || 'ã‚«ã‚¹ã‚¿ãƒ AIã‚³ãƒ¡ãƒ³ãƒˆã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
          }
        })
        .withFailureHandler(function(error) {
          commentTextarea.disabled = false;
          commentTextarea.value = originalValue;
          showResult(false, 'ã‚¨ãƒ©ãƒ¼: ' + error.message);
        })
        .generateTextWithGemini(customPrompt, '');
    }

    // ç¾åœ¨ã®ã‚¹ãƒ©ã‚¤ãƒ‰æƒ…å ±ã‚’å–å¾—
    function loadCurrentSlideInfo() {
      google.script.run
        .withSuccessHandler(function(config) {
          if (config.currentSlideId) {
            const info = document.getElementById('currentSlideInfo');
            info.innerHTML = `<strong>ğŸ“ æ—¢å­˜ã‚¹ãƒ©ã‚¤ãƒ‰:</strong> ID: ${config.currentSlideId.substring(0, 20)}... <br>æ¬¡å›ã¯åŒã˜ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’æ›´æ–°ã—ã¾ã™ã€‚`;
            info.style.display = 'block';
          }
        })
        .getConfigForUI();
    }

    // æœŸé–“é¸æŠ
    function selectPeriod(period) {
      selectedPeriod = period;
      document.querySelectorAll('.period-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      document.querySelector(`[data-period="${period}"]`).classList.add('active');
      // æœŸé–“å¤‰æ›´æ™‚ã«è‡ªå‹•çš„ã«ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
      previewData();
    }

    // ã‚¹ãƒ©ã‚¤ãƒ‰ç”Ÿæˆ
    function generateSlide() {
      const targetDate = document.getElementById('targetDate').value;
      const forceNew = document.getElementById('forceNew').checked;

      if (!targetDate) {
        showResult(false, 'å¯¾è±¡æ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }

      // UIåˆ‡ã‚Šæ›¿ãˆ
      document.getElementById('form').style.display = 'none';
      document.getElementById('loading').classList.add('show');
      document.getElementById('result').classList.remove('show');

      // GASå®Ÿè¡Œ
      google.script.run
        .withSuccessHandler(function(result) {
          document.getElementById('loading').classList.remove('show');
          document.getElementById('form').style.display = 'block';

          if (result.success) {
            const message = result.isNew
              ? `âœ… ${result.message}<br><br>ğŸ”— <a href="${result.slideUrl}" target="_blank">ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’é–‹ã</a><br><small>ID: ${result.slideId}</small>`
              : `âœ… ${result.message}<br><br>ğŸ”— <a href="${result.slideUrl}" target="_blank">ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’é–‹ã</a>`;

            showResult(true, message);

            // æƒ…å ±ã‚’æ›´æ–°
            if (result.isNew) {
              loadCurrentSlideInfo();
            }
          } else {
            showResult(false, result.message);
          }
        })
        .withFailureHandler(function(error) {
          document.getElementById('loading').classList.remove('show');
          document.getElementById('form').style.display = 'block';
          showResult(false, 'ã‚¨ãƒ©ãƒ¼: ' + error.message);
        })
        .generateOrUpdateSlide({
          periodType: selectedPeriod,
          targetDate: targetDate,
          forceNew: forceNew,
          aiComment: document.getElementById('aiComment').value,
          aiInsight: document.getElementById('aiInsight').value
        });
    }

    // çµæœè¡¨ç¤º
    function showResult(success, message) {
      const resultDiv = document.getElementById('result');
      resultDiv.innerHTML = message;
      resultDiv.className = 'result show ' + (success ? 'success' : 'error');
    }

    // æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
    function formatDate(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }
  </script>
</body>
</html>
