以下は「第5章のためのサンプル（毎月更新される）スライド自動生成・自動更新」プロジェクトの**要件定義（詳細版）**です。
※Cursorでそのまま実装に入れる前提で、**スプレッドシート設計 → スライド設計 → GAS設計 → 運用設計**まで落とし込みます。

---

# 1. プロジェクト概要

## 1.1 目的

* 書籍（第5章）の読者が「これをコピペして動かせる」レベルで、
  **サンプルデータを毎月更新 → 4枚程度のGoogleスライドが自動生成/自動更新**される仕組みを提供する。
* “スライド1枚の自動生成”ではなく、**週報/月報っぽい4枚構成**（表紙 + サマリー + グラフ複数）を作り、
  **毎月のデータ差し替えで更新される**設計を提示する。

## 1.2 想定読者

* GAS初心者〜中級
* Google Workspace（個人/組織）で Sheets / Slides を日常利用
* 「毎月の報告資料が同じ構造で、数字だけ変わる」業務を想定

## 1.3 成果物

* Googleスプレッドシート（サンプルデータ＋入力フォーム）
* Googleスライド（テンプレート＋自動反映）
* Google Apps Script（自動生成／更新／トリガー）
* （同一プロジェクト内）図解作成用：プロセス図・構成図の生成（後続タスクでOK。今回は要件に枠だけ作る）

---

# 2. スコープ定義

## 2.1 やること（In Scope）

1. **サンプルデータ生成**

* 月次売上（12か月分）
* 地域別売上（当月）
* 商品カテゴリ別売上（当月）
* KPI（売上合計、前年差、達成率など）

2. **スライド4枚構成のテンプレート**

* 1枚目：表紙（年月、レポート名）
* 2枚目：KPIサマリー（カード + 簡易コメント）
* 3枚目：月次推移（折れ線 or 縦棒）
* 4枚目：地域別（棒）＋カテゴリ別（円）※同一スライドに2チャート配置

3. **GASによる自動化**

* 「指定月」を基準に、Sheetsのデータを更新（または選択）し、Slidesへ反映
* 毎月の自動実行（時間トリガー）
* 手動実行（メニュー/ボタン）

4. **運用・保守を意識した構造**

* 設定値（IDs、対象月、保存先フォルダなど）を一元管理
* エラー時の通知（最低：Logger、任意：メール/Chat/Discordは拡張として）

## 2.2 やらないこと（Out Scope）

* 複雑なダッシュボードやBI相当の機能
* 複数部門・複数顧客へのバッチ生成（将来拡張としては設計余地を残す）
* 外部API連携（今回はSheets内で完結）

---

# 3. 非機能要件（品質・制約）

## 3.1 デザイン方針（重要）

* **ビジネスライク / シンプル**
* **フォント：Noto Sans JP（指定：ユーザー要望 “Noto30JP” は表記ゆれの可能性が高いので、実体は Noto Sans JP を採用）**
* 余白を十分に取り、1枚1メッセージ寄り
* 色は派手にしない（モノトーン + アクセント1色程度）

## 3.2 再現性

* 同じ入力（月・パラメータ）なら同じ出力になる
* スライド更新のたびにレイアウトが崩れない（データ範囲を定義）

## 3.3 保守性

* 関数を責務分離（データ生成／取得／スライド生成／差し替え／トリガー）
* 設定は ScriptProperties または “Config” シートに集約

## 3.4 安全性

* IDやWebhook等の機密は「Config」内に置く場合マスク表示（今回Webhookは必須でないが、将来拡張を見据えてルールだけ定義）
* 生成物は指定フォルダへ保存（Drive散らかり防止）

---

# 4. データ設計（Google Sheets）

## 4.1 シート構成（最小構成）

* `Config`
* `MonthlySales`
* `RegionalSales`
* `CategorySales`
* `KPI`
* （任意）`Log`（実行ログの記録）

---

## 4.2 Config シート仕様

| 項目              | セル例 | 型      | 説明                             |
| --------------- | --: | ------ | ------------------------------ |
| reportTitle     |  B2 | string | 例：月次売上レポート                     |
| targetYearMonth |  B3 | string | `2026-01` 形式                   |
| spreadsheetId   |  B4 | string | このスプレッドシートID（自分自身なら空でも可）       |
| slideTemplateId |  B5 | string | テンプレスライドID                     |
| outputFolderId  |  B6 | string | 出力先フォルダID                      |
| outputMode      |  B7 | enum   | `CREATE_NEW` / `UPDATE_LATEST` |
| latestSlideId   |  B8 | string | 最後に生成したスライドID（UPDATE用）         |

運用ポイント：

* `targetYearMonth` を変えるだけでその月のデータを参照して生成できるようにする
* `latestSlideId` は生成時にGASが書き戻す

---

## 4.3 MonthlySales シート仕様（12か月推移）

* カラム（例）

| Col | 名前        | 型      | 例         |
| --- | --------- | ------ | --------- |
| A   | YearMonth | string | 2025-02   |
| B   | Sales     | number | 12500000  |
| C   | YoY       | number | 1.08（前年比） |
| D   | Memo      | string | 任意        |

ルール：

* 12〜24行程度（前年含むと説明しやすい）
* グラフはこの範囲を参照して作る

---

## 4.4 RegionalSales シート仕様（当月の地域別）

| Col | 名前        | 型      | 例       |
| --- | --------- | ------ | ------- |
| A   | YearMonth | string | 2026-01 |
| B   | Region    | string | 関東      |
| C   | Sales     | number | 5200000 |

地域例（固定でOK）：

* 北海道 / 東北 / 関東 / 中部 / 近畿 / 中国 / 四国 / 九州

---

## 4.5 CategorySales シート仕様（当月のカテゴリ別）

| Col | 名前        | 型      | 例       |
| --- | --------- | ------ | ------- |
| A   | YearMonth | string | 2026-01 |
| B   | Category  | string | サブスク    |
| C   | Sales     | number | 3200000 |

カテゴリ例：

* サブスク / 単発 / 追加オプション / 保守 / その他

---

## 4.6 KPI シート仕様（当月サマリー）

| キー              | 値        | 型      | 例 |
| --------------- | -------- | ------ | - |
| YearMonth       | 2026-01  | string | - |
| TotalSales      | 14500000 | number | - |
| TargetSales     | 15000000 | number | - |
| AchievementRate | 0.967    | number | - |
| MoMGrowth       | 0.12     | number | - |
| YoYGrowth       | 0.08     | number | - |
| Comment         | 好調を維持…   | string | - |

この形式は「縦持ち（Key-Value）」にしておくとGASで扱いやすいです。

---

# 5. スライド設計（Google Slides テンプレート）

## 5.1 共通仕様

* フォント：Noto Sans JP
* テキスト置換：`{{変数名}}` 形式
* 余白：端から最低でも 30px 以上（目安）
* 配色：白背景 + 濃いグレー文字 + アクセント1色

## 5.2 4枚構成（テンプレート）

### Slide 1：表紙

* タイトル：`{{reportTitle}}`
* サブタイトル：`{{targetYearMonth}}`
* 右下：`Generated at {{generatedAt}}`

### Slide 2：KPIサマリー

* KPIカード（4つ）

  * `{{totalSales}}`
  * `{{achievementRate}}`
  * `{{momGrowth}}`
  * `{{yoyGrowth}}`
* コメント欄：`{{comment}}`

### Slide 3：月次推移（折れ線 or 棒）

* Sheetsの `MonthlySales` から作ったチャートを貼り付け
* サブテキスト：`{{trendSummary}}`（例：直近3か月の傾向）

### Slide 4：当月の内訳（2チャート）

* 左：地域別売上（棒）
* 右：カテゴリ別売上（円）
* 右下：`{{insight}}`（例：関東が全体のxx%、サブスク比率上昇）

---

# 6. 自動化仕様（GAS）

## 6.1 実行モード

* `CREATE_NEW`：テンプレをコピーして新規スライドを生成（毎月のアーカイブ向き）
* `UPDATE_LATEST`：最後の生成スライドを更新（常に最新版1つに保つ）

## 6.2 基本フロー

1. Config読み込み
2. 対象年月のデータを取得（KPI / Regional / Category / Monthly）
3. （必要なら）サンプルデータを自動生成・更新
4. Slides生成

   * `CREATE_NEW`なら template をコピーして出力フォルダへ格納
   * `UPDATE_LATEST`なら latestSlideId を開いて更新
5. テキスト置換（replaceAllText）
6. チャート反映

   * Sheets側でチャートを作成（または既存チャート参照）
   * Slidesにリンク付きで貼り付け（または置換）
7. Configへ `latestSlideId` 書き戻し
8. ログ記録

---

## 6.3 関数分割（必須）

### エントリポイント

* `runMonthlyReport()`

  * 手動/トリガー共通の入口

### 設定

* `getConfig_()`
* `updateConfig_(patch)`

### データ層

* `ensureSampleData_(targetYm)`（サンプル生成 or 更新）
* `getKpi_(targetYm)`
* `getMonthlySales_()`
* `getRegionalSales_(targetYm)`
* `getCategorySales_(targetYm)`

### スライド層

* `preparePresentation_(config)`（CREATE_NEW/UPDATE_LATEST）
* `applyTextReplacements_(presentation, payload)`
* `upsertCharts_(presentation, chartRefs)`

  * “貼り付け先のスライド番号・座標・サイズ”をルール化して管理

### 運用

* `createTimeTrigger_()`（毎月x日のy時）
* `logRun_(status, message, meta)`

---

# 7. チャート生成方針（重要）

## 7.1 原則（安定性重視）

* **チャートはSheets側で作成**し、Slidesへ**リンク付き貼り付け**
  → データが更新されれば、リンクされたグラフも更新できる（更新操作は `refresh` 相当の挙動が必要な場合あり）

## 7.2 チャート管理

* シート上に「チャート置き場」エリアを作り、

  * 月次推移チャート
  * 地域別棒チャート
  * カテゴリ別円チャート
    を固定位置に作る。
* GAS側は「何番目のチャートを貼る」方式にする（最も壊れにくい）

---

# 8. 画面・操作要件（読者が迷わない導線）

## 8.1 操作方法（2系統）

1. スプレッドシート上のカスタムメニュー

* `レポート生成` → `今月で生成`
* `レポート生成` → `Configの年月で生成`
* `レポート生成` → `トリガー作成`

2. Apps Script エディタで `runMonthlyReport()` を実行

## 8.2 初期セットアップ手順（本文に載せる前提）

* テンプレスライドIDをConfigへ貼る
* 出力フォルダIDをConfigへ貼る
* 初回実行 → 権限承認 → 生成確認
* トリガー作成

---

# 9. エラーハンドリング要件

## 9.1 代表的な失敗と対策

* `targetYearMonth` が空/不正 → 明示エラー
* 該当月のデータが存在しない → `ensureSampleData_` で生成するか、エラーで止めるかをモード化
* フォルダID不正 → 生成先がMyDrive直下にならないようブロック
* Slidesの置換対象が見つからない → “置換漏れチェック”を入れて警告ログ

## 9.2 ログ仕様（最低限）

* 実行日時
* 実行モード
* 対象年月
* 出力スライドURL
* ステータス（SUCCESS/FAIL）
* エラーメッセージ

---

# 10. 命名規則・ファイル運用

## 10.1 出力スライド名

* `YYYY-MM_月次売上レポート`
  例：`2026-01_月次売上レポート`

## 10.2 バージョン管理

* テンプレはID固定（変更履歴で戻せる）
* 出力物は毎月アーカイブ（CREATE_NEW推奨）
* UPDATE_LATESTは「運用サンプル」として紹介（目的が違うため）

---

# 11. 受け入れ条件（Acceptance Criteria）

1. `targetYearMonth = 2026-01` で実行すると、スライドが4枚生成される
2. Slide1の `{{targetYearMonth}}` が置換されている
3. KPI数値がスライド2に反映されている
4. Slide3に月次推移グラフが貼られている（リンク付き）
5. Slide4に地域棒＋カテゴリ円が貼られている
6. `CREATE_NEW` では毎回新しいスライドが出力される
7. `UPDATE_LATEST` では同じスライドIDが更新される
8. エラー時にログが残り、原因が分かる

---

# 12. 拡張要件（同一プロジェクトで後で足せる）

* Discord通知（Webhook）
* 生成後にPDF出力してDriveに保存
* Slack/Chat通知
* 複数部門（部門別シート）→ 部門ごとにスライド生成
* AIコメント自動生成（KPIから一言コメントを生成して `Comment` に書き戻す）

---

# 13. 図解（書籍用）を作るための“画像要件”（今回は枠だけ定義）

このプロジェクト内で、図解用に最低2つの画像（またはスライド図形）を作る前提。

1. **全体アーキテクチャ図**

* Sheets（データ）→ GAS（処理）→ Slides（出力）→ Trigger（定期実行）

2. **データ→スライド反映の処理フロー図**

* Config読込 → データ取得 → テンプレ複製 → 置換 → チャート貼付 → 出力

※実際の作図は「GASで図形生成」でも「画像生成」でも良いが、
本文の整合性・再現性を優先して、まずは **Slidesの図形（矩形＋矢印）で作る**のが安定。

---

## 次にやるべきこと（実装に入るための最短ルート）

* **(A)** サンプルデータ（数値のレンジ・行数・地域/カテゴリ）を確定
* **(B)** テンプレスライド4枚の“座標ルール”を決める（どこに何を置くか固定）
* **(C)** `Config` のキーを確定して、GAS骨格（関数分割）から書き始める

このまま続けて、次の返答で **「サンプルデータの具体値（12か月＋地域＋カテゴリの実データ例）」**まで作って、Sheetsに貼り付けできる形（CSV/表）で出します。
