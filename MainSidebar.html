<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Noto Sans JP', -apple-system, BlinkMacSystemFont, sans-serif;
      padding: 0;
      background: #f8f9fa;
    }
    .header {
      background: linear-gradient(135deg, #0f9d58 0%, #0b8043 100%);
      color: white;
      padding: 20px 16px;
      text-align: center;
    }
    .header h2 {
      font-size: 18px;
      margin-bottom: 4px;
    }
    .header p {
      font-size: 12px;
      opacity: 0.9;
    }
    .section {
      background: white;
      margin: 12px;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .section-title {
      font-size: 13px;
      font-weight: 700;
      color: #0f9d58;
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .period-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 8px;
      margin-bottom: 12px;
    }
    .period-btn {
      padding: 10px;
      border: 2px solid #c8e6c9;
      border-radius: 8px;
      background: white;
      cursor: pointer;
      transition: all 0.3s;
      text-align: center;
      font-size: 11px;
      font-weight: 600;
    }
    .period-btn:hover {
      border-color: #0f9d58;
      background: #e8f5e9;
    }
    .period-btn.active {
      border-color: #0f9d58;
      background: linear-gradient(135deg, #0f9d58 0%, #0b8043 100%);
      color: white;
    }
    .period-btn .icon {
      font-size: 20px;
      margin-bottom: 4px;
    }
    input[type="date"] {
      width: 100%;
      padding: 10px;
      border: 2px solid #c8e6c9;
      border-radius: 8px;
      font-size: 13px;
      margin-bottom: 12px;
    }
    input[type="date"]:focus {
      outline: none;
      border-color: #0f9d58;
    }
    .checkbox-item {
      display: flex;
      align-items: center;
      padding: 8px 0;
    }
    .checkbox-item input {
      margin-right: 8px;
    }
    .checkbox-item label {
      font-size: 12px;
      cursor: pointer;
    }
    .btn {
      width: 100%;
      padding: 12px 16px;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      margin-bottom: 8px;
    }
    .btn-primary {
      background: linear-gradient(135deg, #0f9d58 0%, #0b8043 100%);
      color: white;
    }
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(15, 157, 88, 0.4);
    }
    .btn-secondary {
      background: #e8f5e9;
      color: #0f9d58;
    }
    .btn-secondary:hover {
      background: #c8e6c9;
    }
    .result {
      display: none;
      padding: 12px;
      border-radius: 8px;
      margin: 12px;
      font-size: 12px;
      line-height: 1.6;
    }
    .result.show { display: block; }
    .result.success {
      background: #d1fae5;
      border: 2px solid #6ee7b7;
      color: #065f46;
    }
    .result.error {
      background: #fee2e2;
      border: 2px solid #fca5a5;
      color: #991b1b;
    }
    .result a {
      color: #0284c7;
      font-weight: 600;
      text-decoration: none;
    }
    .loading {
      display: none;
      text-align: center;
      padding: 20px;
      color: #0f9d58;
    }
    .loading.show { display: block; }
    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #0f9d58;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      animation: spin 1s linear infinite;
      margin: 0 auto 12px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    textarea {
      width: 100%;
      min-height: 80px;
      padding: 10px;
      border: 2px solid #c8e6c9;
      border-radius: 8px;
      font-size: 12px;
      font-family: inherit;
      resize: vertical;
      margin-bottom: 8px;
    }
    textarea:focus {
      outline: none;
      border-color: #0f9d58;
    }
    .current-slide-box {
      background: #e0f2fe;
      border-left: 4px solid #0284c7;
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 12px;
      font-size: 11px;
      color: #0c4a6e;
    }
  </style>
</head>
<body>
  <div class="header">
    <h2>ğŸ“Š ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ</h2>
    <p>æœŸé–“ã‚’é¸æŠã—ã¦ãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆãƒ»æ›´æ–°</p>
  </div>

  <div id="result" class="result"></div>
  <div id="currentSlideInfo" class="current-slide-box" style="display:none; margin: 12px;"></div>

  <!-- ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ -->
  <div class="section">
    <div class="section-title">ğŸ“… æœŸé–“é¸æŠ</div>
    <div class="period-buttons">
      <button class="period-btn active" data-period="monthly" onclick="selectPeriod('monthly')">
        <div class="icon">ğŸ“†</div>
        <div>æœˆæ¬¡</div>
      </button>
      <button class="period-btn" data-period="weekly" onclick="selectPeriod('weekly')">
        <div class="icon">ğŸ“…</div>
        <div>é€±æ¬¡</div>
      </button>
      <button class="period-btn" data-period="yearly" onclick="selectPeriod('yearly')">
        <div class="icon">ğŸ“Š</div>
        <div>å¹´æ¬¡</div>
      </button>
    </div>

    <div id="periodSelector">
      <!-- æœˆæ¬¡é¸æŠ -->
      <div id="monthlySelector" style="display: block;">
        <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #4b5563; font-size: 12px;">å¯¾è±¡æœˆ</label>
        <select id="monthlyYear" style="width: 48%; padding: 10px; border: 2px solid #c8e6c9; border-radius: 8px; font-size: 13px; margin-right: 4%;">
          <option value="2025">2025å¹´</option>
          <option value="2024">2024å¹´</option>
        </select>
        <select id="monthlyMonth" style="width: 48%; padding: 10px; border: 2px solid #c8e6c9; border-radius: 8px; font-size: 13px;">
          <option value="1">1æœˆ</option>
          <option value="2">2æœˆ</option>
          <option value="3">3æœˆ</option>
          <option value="4">4æœˆ</option>
          <option value="5">5æœˆ</option>
          <option value="6">6æœˆ</option>
          <option value="7">7æœˆ</option>
          <option value="8">8æœˆ</option>
          <option value="9">9æœˆ</option>
          <option value="10">10æœˆ</option>
          <option value="11">11æœˆ</option>
          <option value="12">12æœˆ</option>
        </select>
      </div>

      <!-- é€±æ¬¡é¸æŠ -->
      <div id="weeklySelector" style="display: none;">
        <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #4b5563; font-size: 12px;">å¯¾è±¡é€±</label>
        <select id="weeklyYear" style="width: 48%; padding: 10px; border: 2px solid #c8e6c9; border-radius: 8px; font-size: 13px; margin-right: 4%;">
          <option value="2025">2025å¹´</option>
          <option value="2024">2024å¹´</option>
        </select>
        <select id="weeklyWeek" style="width: 48%; padding: 10px; border: 2px solid #c8e6c9; border-radius: 8px; font-size: 13px;">
          <!-- JavaScriptã§å‹•çš„ç”Ÿæˆ -->
        </select>
      </div>

      <!-- å¹´æ¬¡é¸æŠ -->
      <div id="yearlySelector" style="display: none;">
        <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #4b5563; font-size: 12px;">å¯¾è±¡å¹´</label>
        <select id="yearlyYear" style="width: 100%; padding: 10px; border: 2px solid #c8e6c9; border-radius: 8px; font-size: 13px;">
          <option value="2025">2025å¹´</option>
          <option value="2024">2024å¹´</option>
          <option value="2023">2023å¹´</option>
        </select>
      </div>
    </div>

    <div class="checkbox-item" style="margin-top: 12px;">
      <input type="checkbox" id="forceNew" />
      <label for="forceNew">å¼·åˆ¶çš„ã«æ–°è¦ä½œæˆ</label>
    </div>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 12px;">
      <button class="btn btn-secondary" onclick="filterData()">
        ğŸ” ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
      </button>
      <button class="btn btn-secondary" onclick="clearFilter()">
        ğŸ”„ ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼è§£é™¤
      </button>
    </div>

    <div id="previewArea" style="display: none; margin-top: 12px; padding: 12px; background: #f0f9ff; border-radius: 8px; border: 2px solid #0284c7;">
      <div style="font-weight: 700; color: #0369a1; margin-bottom: 8px; font-size: 12px;">ğŸ“‹ ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°çµæœãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</div>
      <div id="previewContent" style="font-size: 11px; color: #0c4a6e; line-height: 1.6;"></div>
    </div>

    <button class="btn btn-primary" onclick="generateSlide()" style="margin-top: 12px;">
      ğŸš€ ç”Ÿæˆãƒ»æ›´æ–°
    </button>
  </div>

  <!-- AIç”Ÿæˆ -->
  <div class="section">
    <div class="section-title">ğŸ¤– AIç”Ÿæˆ</div>
    <button class="btn btn-secondary" onclick="generateAI()">
      ğŸ’¬ å£²ä¸Šã‚³ãƒ¡ãƒ³ãƒˆç”Ÿæˆ
    </button>
    <textarea id="customPrompt" placeholder="ã‚«ã‚¹ã‚¿ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ...">å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æã—ã¦ã€ä»Šæœˆã®å‚¾å‘ã¨é‡è¦ãªãƒã‚¤ãƒ³ãƒˆã‚’ç°¡æ½”ã«ã¾ã¨ã‚ã¦ãã ã•ã„ã€‚æ•°å€¤ã‚’å«ã‚ã¦ã€200æ–‡å­—ç¨‹åº¦ã§å…·ä½“çš„ã«è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚</textarea>
    <button class="btn btn-secondary" onclick="generateCustomAI()">
      âœï¸ ã‚«ã‚¹ã‚¿ãƒ ç”Ÿæˆ
    </button>
  </div>

  <div id="loading" class="loading">
    <div class="spinner"></div>
    <p style="font-size: 13px;">å‡¦ç†ä¸­...</p>
  </div>

  <script>
    let selectedPeriod = 'monthly';
    let availablePeriods = null;
    let previewData = null;

    window.onload = function() {
      loadCurrentSlideInfo();
      loadAvailablePeriods();
    };

    function loadAvailablePeriods() {
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            availablePeriods = result;
            initializeSelectors();
          } else {
            // ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§åˆæœŸåŒ–
            initializeDefaultSelectors();
          }
        })
        .withFailureHandler(function(error) {
          initializeDefaultSelectors();
        })
        .getAvailablePeriods();
    }

    function initializeSelectors() {
      const today = new Date();

      // å¹´æ¬¡é¸æŠã®åˆæœŸåŒ–
      const yearlyYear = document.getElementById('yearlyYear');
      yearlyYear.innerHTML = '';
      availablePeriods.years.forEach(year => {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = `${year}å¹´`;
        yearlyYear.appendChild(option);
      });
      yearlyYear.value = today.getFullYear();

      // æœˆæ¬¡é¸æŠã®åˆæœŸåŒ–
      const monthlyYear = document.getElementById('monthlyYear');
      monthlyYear.innerHTML = '';
      availablePeriods.years.forEach(year => {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = `${year}å¹´`;
        monthlyYear.appendChild(option);
      });
      monthlyYear.value = today.getFullYear();

      updateMonthOptions(today.getFullYear());
      document.getElementById('monthlyMonth').value = today.getMonth() + 1;

      // é€±æ¬¡é¸æŠã®åˆæœŸåŒ–ï¼ˆæ—¥ä»˜ç¯„å›²è¡¨ç¤ºï¼‰
      const weeklyYear = document.getElementById('weeklyYear');
      weeklyYear.innerHTML = '';
      availablePeriods.years.forEach(year => {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = `${year}å¹´`;
        weeklyYear.appendChild(option);
      });
      weeklyYear.value = today.getFullYear();

      updateWeekOptions(today.getFullYear());

      // å¹´å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆã®è¨­å®š
      monthlyYear.addEventListener('change', function() {
        updateMonthOptions(this.value);
      });
      weeklyYear.addEventListener('change', function() {
        updateWeekOptions(this.value);
      });
    }

    function updateMonthOptions(year) {
      const monthSelect = document.getElementById('monthlyMonth');
      const availableMonths = availablePeriods.yearMonths.filter(ym => ym.year == year);

      monthSelect.innerHTML = '';
      availableMonths.forEach(ym => {
        const option = document.createElement('option');
        option.value = ym.month;
        option.textContent = `${ym.month}æœˆ`;
        monthSelect.appendChild(option);
      });
    }

    function updateWeekOptions(year) {
      const weekSelect = document.getElementById('weeklyWeek');
      const availableWeeks = availablePeriods.weeks.filter(w => w.year == year);

      weekSelect.innerHTML = '';
      availableWeeks.forEach(w => {
        const option = document.createElement('option');
        option.value = w.startDate;
        option.textContent = w.label;
        weekSelect.appendChild(option);
      });
    }

    function initializeDefaultSelectors() {
      const today = new Date();

      // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®æœˆæ¬¡é¸æŠ
      document.getElementById('monthlyYear').value = today.getFullYear();
      document.getElementById('monthlyMonth').value = today.getMonth() + 1;

      // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®é€±æ¬¡é¸æŠï¼ˆç¬¬1é€±ã€œç¬¬52é€±ï¼‰
      const weekSelect = document.getElementById('weeklyWeek');
      for (let i = 1; i <= 52; i++) {
        const option = document.createElement('option');
        option.value = i;
        option.textContent = `ç¬¬${i}é€±`;
        weekSelect.appendChild(option);
      }
      document.getElementById('weeklyYear').value = today.getFullYear();
      const weekNum = Math.ceil((today - new Date(today.getFullYear(), 0, 1)) / (7 * 24 * 60 * 60 * 1000));
      weekSelect.value = weekNum;

      // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®å¹´æ¬¡é¸æŠ
      document.getElementById('yearlyYear').value = today.getFullYear();
    }

    function loadCurrentSlideInfo() {
      google.script.run
        .withSuccessHandler(function(config) {
          if (config.currentSlideId) {
            const info = document.getElementById('currentSlideInfo');
            info.innerHTML = `ğŸ“ æ—¢å­˜ã‚¹ãƒ©ã‚¤ãƒ‰: ${config.currentSlideId.substring(0, 15)}...<br>æ¬¡å›ã¯åŒã˜ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’æ›´æ–°ã—ã¾ã™`;
            info.style.display = 'block';
          }
        })
        .getConfigForUI();
    }

    function selectPeriod(period) {
      selectedPeriod = period;
      document.querySelectorAll('.period-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      document.querySelector(`[data-period="${period}"]`).classList.add('active');

      // æœŸé–“é¸æŠUIã®åˆ‡ã‚Šæ›¿ãˆ
      document.getElementById('monthlySelector').style.display = period === 'monthly' ? 'block' : 'none';
      document.getElementById('weeklySelector').style.display = period === 'weekly' ? 'block' : 'none';
      document.getElementById('yearlySelector').style.display = period === 'yearly' ? 'block' : 'none';
    }

    function filterData() {
      let targetDate, periodLabel;

      // é¸æŠã•ã‚ŒãŸæœŸé–“ã«å¿œã˜ã¦æ—¥ä»˜ã‚’ä½œæˆ
      if (selectedPeriod === 'monthly') {
        const year = document.getElementById('monthlyYear').value;
        const month = document.getElementById('monthlyMonth').value;
        targetDate = `${year}-${String(month).padStart(2, '0')}-01`;
        periodLabel = `${year}å¹´${month}æœˆ`;
      } else if (selectedPeriod === 'weekly') {
        const year = document.getElementById('weeklyYear').value;
        const weekValue = document.getElementById('weeklyWeek').value;

        targetDate = weekValue;

        const weekSelect = document.getElementById('weeklyWeek');
        const selectedOption = weekSelect.options[weekSelect.selectedIndex];
        periodLabel = `${year}å¹´ ${selectedOption.textContent}`;
      } else if (selectedPeriod === 'yearly') {
        const year = document.getElementById('yearlyYear').value;
        targetDate = `${year}-01-01`;
        periodLabel = `${year}å¹´`;
      }

      showLoading(`ğŸ” ${periodLabel} ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ä¸­...`);
      google.script.run
        .withSuccessHandler(function(result) {
          hideLoading();
          if (result.success) {
            previewData = result;
            displayPreview(result, periodLabel);
          } else {
            showResult(false, result.message);
          }
        })
        .withFailureHandler(handleError)
        .previewReportData(selectedPeriod, targetDate);
    }

    function displayPreview(data, periodLabel) {
      const previewArea = document.getElementById('previewArea');
      const previewContent = document.getElementById('previewContent');

      const growthRate = data.totalSalesChange || 0;
      const sign = growthRate >= 0 ? '+' : '';
      const growthText = sign + (growthRate * 100).toFixed(1) + '%';

      // æˆé•·ç‡ãƒ©ãƒ™ãƒ«ã‚’æœŸé–“ã‚¿ã‚¤ãƒ—ã«å¿œã˜ã¦è¨­å®š
      let growthLabel = 'æˆé•·ç‡';
      if (selectedPeriod === 'monthly') {
        growthLabel = 'å‰æœˆæ¯”';
      } else if (selectedPeriod === 'yearly') {
        growthLabel = 'å‰å¹´æ¯”';
      } else if (selectedPeriod === 'weekly') {
        growthLabel = 'å‰é€±æ¯”';
      }

      let html = `<strong>å¯¾è±¡æœŸé–“:</strong> ${periodLabel}<br><br>`;
      html += `<strong>ğŸ“Š åˆè¨ˆå£²ä¸Š:</strong> ${formatCurrency(data.totalSales)}<br><br>`;
      html += `<strong>ğŸ“ˆ ${growthLabel}:</strong> ${growthText}<br><br>`;
      html += `<strong>ğŸ† ãƒˆãƒƒãƒ—åœ°åŸŸ:</strong> ${data.topRegion} (${formatCurrency(data.topRegionSales)})<br><br>`;
      html += `<strong>ğŸ‘¤ ãƒˆãƒƒãƒ—æ‹…å½“è€…:</strong> ${data.topPerson} (${formatCurrency(data.topPersonSales)})<br><br>`;
      html += `<strong>ğŸ’¡ è€ƒå¯Ÿ:</strong><br>${data.aiComment || 'ãªã—'}`;

      previewContent.innerHTML = html;
      previewArea.style.display = 'block';
      showResult(true, 'âœ… ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å®Œäº†ï¼ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ç¢ºèªã—ã¦ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚');
    }

    function formatCurrency(value) {
      return `Â¥${Math.round(value).toLocaleString()}`;
    }

    function clearFilter() {
      showLoading('ğŸ”„ ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’è§£é™¤ä¸­...');
      google.script.run
        .withSuccessHandler(function(result) {
          hideLoading();
          if (result.success) {
            // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒªã‚¢ã‚’éè¡¨ç¤º
            document.getElementById('previewArea').style.display = 'none';
            previewData = null;
            showResult(true, 'âœ… ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’è§£é™¤ã—ã¾ã—ãŸã€‚å…¨æœŸé–“ã®ãƒ‡ãƒ¼ã‚¿ã«æˆ»ã‚Šã¾ã—ãŸã€‚');
          } else {
            showResult(false, result.message);
          }
        })
        .withFailureHandler(handleError)
        .clearDataFilter();
    }

    function generateSlide() {
      const forceNew = document.getElementById('forceNew').checked;
      let targetDate, periodLabel;

      // é¸æŠã•ã‚ŒãŸæœŸé–“ã«å¿œã˜ã¦æ—¥ä»˜ã‚’ä½œæˆ
      if (selectedPeriod === 'monthly') {
        const year = document.getElementById('monthlyYear').value;
        const month = document.getElementById('monthlyMonth').value;
        targetDate = `${year}-${String(month).padStart(2, '0')}-01`;
        periodLabel = `${year}å¹´${month}æœˆ`;
      } else if (selectedPeriod === 'weekly') {
        const year = document.getElementById('weeklyYear').value;
        const weekValue = document.getElementById('weeklyWeek').value;

        // weekValueãŒstartDateã®æ–‡å­—åˆ—ï¼ˆyyyy-mm-ddï¼‰
        targetDate = weekValue;

        // ãƒ©ãƒ™ãƒ«ã¯é¸æŠã•ã‚ŒãŸoptionè¦ç´ ã®ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰å–å¾—
        const weekSelect = document.getElementById('weeklyWeek');
        const selectedOption = weekSelect.options[weekSelect.selectedIndex];
        periodLabel = `${year}å¹´ ${selectedOption.textContent}`;
      } else if (selectedPeriod === 'yearly') {
        const year = document.getElementById('yearlyYear').value;
        targetDate = `${year}-01-01`;
        periodLabel = `${year}å¹´`;
      }

      showLoading(`ğŸ“Š ${periodLabel} ã®ãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆä¸­...`);

      // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°ãã®AIã‚³ãƒ¡ãƒ³ãƒˆã‚’ä½¿ç”¨
      const params = {
        periodType: selectedPeriod,
        targetDate: targetDate,
        forceNew: forceNew
      };

      if (previewData) {
        params.aiComment = previewData.aiComment;
      }

      google.script.run
        .withSuccessHandler(function(result) {
          hideLoading();
          if (result.success) {
            const msg = result.isNew
              ? `âœ… æ–°è¦ä½œæˆå®Œäº†<br><strong>${periodLabel}</strong><br><a href="${result.slideUrl}" target="_blank">ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’é–‹ã</a>`
              : `âœ… æ›´æ–°å®Œäº†<br><strong>${periodLabel}</strong><br><a href="${result.slideUrl}" target="_blank">ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’é–‹ã</a>`;
            showResult(true, msg);
            if (result.isNew) loadCurrentSlideInfo();

            // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢
            previewData = null;
            document.getElementById('previewArea').style.display = 'none';
          } else {
            showResult(false, result.message);
          }
        })
        .withFailureHandler(handleError)
        .generateOrUpdateSlide(params);
    }

    function generateAI() {
      showLoading();
      google.script.run
        .withSuccessHandler(handleAIResult)
        .withFailureHandler(handleError)
        .generateAIComment();
    }

    function generateCustomAI() {
      const prompt = document.getElementById('customPrompt').value;
      if (!prompt.trim()) {
        showResult(false, 'ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }

      showLoading();
      google.script.run
        .withSuccessHandler(handleAIResult)
        .withFailureHandler(handleError)
        .generateCustomText(prompt);
    }

    function handleAIResult(result) {
      hideLoading();
      if (result.success) {
        showResult(true, `<strong>âœ… ç”Ÿæˆå®Œäº†</strong><br><br>${result.text}<br><br><button class="btn btn-secondary" onclick="copyText('${escapeHtml(result.text)}')">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>`);
      } else {
        showResult(false, result.message);
      }
    }

    function copyText(text) {
      navigator.clipboard.writeText(text).then(() => {
        alert('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
      });
    }

    function showLoading(message) {
      const loadingDiv = document.getElementById('loading');
      if (message) {
        loadingDiv.querySelector('p').textContent = message;
      } else {
        loadingDiv.querySelector('p').textContent = 'å‡¦ç†ä¸­...';
      }
      loadingDiv.classList.add('show');
      document.getElementById('result').classList.remove('show');
    }

    function hideLoading() {
      document.getElementById('loading').classList.remove('show');
    }

    function showResult(success, message) {
      const resultDiv = document.getElementById('result');
      resultDiv.innerHTML = message;
      resultDiv.className = 'result show ' + (success ? 'success' : 'error');
    }

    function handleError(error) {
      hideLoading();
      showResult(false, 'ã‚¨ãƒ©ãƒ¼: ' + error.message);
    }

    function formatDate(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    function escapeHtml(text) {
      return text.replace(/'/g, "\\'").replace(/"/g, '\\"').replace(/\n/g, '\\n');
    }
  </script>
</body>
</html>
